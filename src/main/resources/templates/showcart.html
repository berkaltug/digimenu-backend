<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
      xmlns="http://www.w3.org/1999/xhtml">
<head>
    <th:block th:replace="fragments/head :: head"></th:block>
</head>
<body>

<th:block th:include=" fragments/header :: body"></th:block>

<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h3 style="color:white;background-color: #2f2f2f;margin-bottom: 1rem;">Masa <span id="masaNo"
                                                                                              th:text="${masaNo}"></span>
            </h3>
            <table id="hesapTable" class="table table-striped table-dark">
                <thead>
                <tr>
                    <th style="width:23%">Sipariş</th>
                    <th style="width:10%">Fiyat</th>
                    <th style="width:14%">Tarih</th>
                    <th style="width:23%">Mesaj</th>
                    <th style="width:12%">Teslim Edildi</th>
                    <th style="width:9%">İptal</th>
                    <th style="width:9%">Ödendi</th>
                </tr>
                </thead>
                <tbody>
                <th:block th:if="${orders!=null and !orders.isEmpty()}">
                    <tr class="siparisItem" th:each=" o : ${orders}">
                        <td th:text="${o.item}"></td>
                        <td class="price" th:text="${o.price}" th:value="${o.price}" name="price"></td>
                        <td th:text="${#dates.format(o.siparisTarihi, 'dd-MM-yyyy HH:mm')}"></td>
                        <th:block th:if="${!o.message.isEmpty()}">
                            <td th:text="${o.message}"></td>
                        </th:block>
                        <th:block th:if="${o.message.isEmpty()}">
                            <td>-</td>
                        </th:block>
                        <td>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" th:id="'customSwitch' + ${o.id}" th:checked="${o.getDelivered()}" >
                                <label class="custom-control-label" th:for="'customSwitch' + ${o.id}" ></label>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" th:id="*{o.id}">İptal Et</button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" th:id="*{o.id}">Ödendi</button>
                        </td>
                    </tr>
                    <tr>
                        <td>Toplam Ücret</td>
                        <td id="toplamUcret"></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>
                            <a th:href="@{'/restaurant/flushcart/' + *{orders[0].masaNo}}" class="btn btn-success">Hesap
                                Ödendi <span class="fa fa-check"></span></a>
                        </td>
                    </tr>
                </th:block>
                <th:block th:if="${orders.isEmpty()}">
                    <tr>
                        <td>Masada Sipariş Bulunmamaktadır.</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </th:block>
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        calculateTotalPrize()
    });

    function calculateTotalPrize() {
        var totalPrice2 = 0.0;
        $('#hesapTable tbody .siparisItem').each(function (index, item) {
            totalPrice2 += parseFloat($(item).children(".price").html());
        });
        $('#toplamUcret').html(totalPrice2);
    }

    function deleteItem(id, obj) {
        var $btn = obj;
        $btn.attr('disabled', true);
        $.ajax({
            type: "GET",
            contentType: "application/json",
            xhrFields: {
                useCredentials: true,
            },
            url: "/restaurant/flushitem/" + id,
            success: function (data) {
                $btn.closest("tr").remove();
                calculateTotalPrize();
            },
            error: function (xhr, status, error) {
                alert("Sunucuda bir problem oluştu ve ürün silinemedi.Daha sonra tekrar deneyiniz.");
                $btn.attr('disabled', false);
            }
        });
    }

    function deleteWrongOrder(name, masaNo, cartId, obj) {
        var $btn = obj;
        $.ajax({
            type: "GET",
            contentType: "application/json",
            xhrFields: {
                useCredentials: true,
            },
            url: "/restaurant/delete-wrong-order/" + name + "/" + masaNo + "/" + cartId,
            success: function (data) {
                $btn.closest("tr").remove();
                calculateTotalPrize();
            },
            error: function (xhr, status, error) {
                alert("Sunucuda bir problem oluştu ve ürün silinemedi.Daha sonra tekrar deneyiniz.");
                $btn.attr('disabled', false);
            }
        });
    }

    function setDeliveryOption(id, value,obj) {
        var $switch = obj;

            $.ajax({
                type: "POST",
                contentType: "application/json",
                xhrFields: {
                    useCredentials: true,
                },
                data:JSON.stringify({
                    value:value,
                    id:id
                }),
                url: "/restaurant/delivery",
                success: function (data) {
                    console.log("successfully delivered");
                },
                error: function (xhr, status, error) {
                    alert("Sunucuda bir problem oluştu.Daha sonra tekrar deneyiniz.");

                }
            });
    }

    $('#hesapTable').on('click', '.btn-warning', function () {
        deleteItem($(this).attr('id'), $(this));
    });

    $('#hesapTable').on('click', '.btn-danger', function () {
        var name = $(this).closest("tr").find("td:eq(0)").text();
        var masaNo = $("#masaNo").text();
        var cartId = $(this).attr("id");
        deleteWrongOrder(name, masaNo, cartId, $(this));
    });

    $('#hesapTable').on('click','.custom-control-input',function(){
        var value=$(this).is(':checked');
        var id =$(this).closest("tr").find("button.btn-danger").prop("id");
        setDeliveryOption(id,value,$(this));
    })


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
</body>
</html>
